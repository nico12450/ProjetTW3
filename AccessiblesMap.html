<!doctype html>
<html lang="en">
  <head>
	<meta style = "utf-8" charset = 'utf-8'>
    <style>
      .map {
        height: 100%;
        width: 100%;
      }
    </style>
    <style>
       #map {
        height: 700px;
        width: 100%;

       }
	#panel{
	    text-align: center;
	    background-color: #e5eecc;
	    border: solid 1px #c3c3c3;
			display: none;
	}
    </style>
    <script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script> 
$(document).ready(function(){
    $("button").click(function(){
        $("#panel").slideToggle("slow");
    });
});
</script>

    <title>Google map api</title>
  </head>
  <body>
	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<h1>Tournages de films sur paris de 2002 à 2010</h1>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-xs-12">
	
	<div class="btn-group ">
        <button data-toggle="dropdown" class="btn  btn-default dropdown-toggle" type="button" id="btnGroupVerticalDrop1">
            Années de tournage <span class="caret"></span>
        </button>
        <ul aria-labelledby="btnGroupVerticalDrop1" role="menu" class="dropdown-menu">
          <li><a href="#" onClick = "initMap()">2002 a 2010</a></li>
          <li><a href="#" onClick = "annee('2002')">2002</a></li>
		  <li><a href="#" onClick = "annee('2003')">2003</a></li>
          <li><a href="#" onClick = "annee('2004')">2004</a></li>
		  <li><a href="#" onClick = "annee('2005')">2005</a></li>
          <li><a href="#" onClick = "annee('2006')">2006</a></li>
		  <li><a href="#" onClick = "annee('2007')">2007</a></li>
          <li><a href="#" onClick = "annee('2008')">2008</a></li>
		  <li><a href="#" onClick = "annee('2009')">2009</a></li>
          <li><a href="#" onClick = "annee('2010')">2010</a></li>
        </ul>
	</div>

				<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="false">
					<div class="panel panel-default">
						<div class="panel-heading" role="tab" id="headingOne">
							<h4 class="panel-title">
								<a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
									<span class="glyphicon glyphicon-film" aria-hidden="true"></span> Ajouter un film
								</a>
							</h4>
						</div>

						<div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
							<div class="panel-body">

								<form id="formAjout" role="form" class="from-horizontal">
									<div class="form-group">
										<label for="Titre" class="col-xs-1 control-label">Titre</label>
										<div class="col-xs-5 control-label">
											<input id="titre" type="text" placeholder="Le titre du film" class="form-control" required><br/>
										</div>
										<label for="dep" class="col-xs-1 control-label" >Realisateur</label>
										<div class="col-xs-5 control-label">
											<input id="realisateur" type="text" min="0" class="form-control" placeholder="Nom de famille" ><br/>
										</div>
									</div>
									
									<div class="form-group">
										<label for="date" class="col-xs-1 control-label">Date debut</label>
										<div class="col-xs-5 control-label">
											<input id="date" type="date" class="form-control" placeholder="Date du film" ><br/>
										</div>
										<label for="heure" class="col-xs-1 control-label">Date fin</label>
										<div class="col-xs-5 control-label">
											<input id="heure" type="time" class="form-control" placeholder="Date du film" ><br/>
										</div>
									</div>
									
									<div class="form-group">
										<label for="lieu" class="col-xs-1 control-label">Lieu</label>
										<div class="col-xs-5 control-label">
											<input type="radio" name="souhait" value="riche" id="cadreE" /> <label for="riche">Exterieur</label>
											<input type="radio" name="souhait" value="celebre" id="cadreD" /> <label for="celebre">Domaine public</label>
										</div>
										<label for="lieu" class="col-xs-1 control-label">Lieu tournage</label>
										<div class="col-xs-5 control-label">
											<input id="lieu" type="text" min="0" class="form-control" placeholder="lieu du tournage" ><br/>
										</div>
									</div>
									
									<div class="form-group">
										<label for="code postal" class="col-xs-2 control-label">Arrondissement</label>
										<div class="col-xs-2 control-label">
											<input id="arrondissement" type="number" class="form-control" placeholder="Code postal" required><br/>
										</div>
										<label for="heure" class="col-xs-1 control-label">Longitude</label>
										<div class="col-xs-3 control-label">
											<input id="longitude" type="number" class="form-control" required><br/>
										</div>
										<label for="heure" class="col-xs-1 control-label">Latitude</label>
										<div class="col-xs-3 control-label">
											<input id="latitude" type="number" class="form-control" required><br/>
										</div>
									</div>
									
									<div class="form-group">
										<label for="Adresse" class="col-xs-1 control-label">Adresse</label>
										<div class="col-xs-5 control-label">
											<input id="adresse" type="text"  class="form-control" ><br/>
										</div>
										<label for="dep" class="col-xs-1 control-label" >Adresse complete</label>
										<div class="col-xs-5 control-label">
											<input id="adresse_complete" type="text" class="form-control"  ><br/>
										</div>
									</div>

									<div class="form-group">
										<div class="col-xs-offset-5 col-xs-5">
											<button type="submit" class="btn btn-primary" value="Envoyer >Ajouter</button>&nbsp;<a id="aide" href="aide.html">Aide</a>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

    <div id="map"></div>
    <canvas id="myChart" width="400" height="400"></canvas>
    <script type="text/javascript">
	
window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
	
const films = [];
const dbName = "MaBase";	
var idbSupported = false;
var db;
var listePositions = [];
var filmsParArr = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
 
document.addEventListener("DOMContentLoaded", function(){
	var tableau;
	$.ajax({
		 url : 'https://raw.githubusercontent.com/nico12450/ProjetTW3/master/tournagesdefilmsparis2011.json',
		 type : 'GET',
		 dataType : 'JSON',
		 success : function(data, statut){
		    tableau = $.parseJSON(JSON.stringify(data));
		    creationBase(tableau);
		 },
		 error : function(resultat, statut, erreur){
		    console.log(erreur);
		 },
		 complete : function(resultat, statut){
		    console.log("tableau de données créé");
		 }
	});


	var creationBase = function(tableau){
   	 	indexedDB.deleteDatabase("BaseFilms");
    	if("indexedDB" in window) {
     	   idbSupported = true;
   		 }
    	else{
    	    window.alert("Votre navigateur ne supporte pas une version stable d'IndexedDB. Quelques fonctionnalités ne seront pas disponibles.");
    	}
			if(idbSupported) {
					var openRequest = indexedDB.open("BaseFilms",3);
 
      		openRequest.onupgradeneeded = function(e) {
							console.log("running onupgradeneeded");
							db = e.target.result;
							var table = db.createObjectStore("Films",{autoIncrement: true});
		//table.createIndex("nom", "nom", {unique: false});
		//table.createIndex("arrondissement", "arrondissement", {unique: false});
							table.transaction.oncomplete = function(e){
									var tableFilm = db.transaction(["Films"], "readwrite").objectStore("Films");
	        				ajoutFilm(tableFilm, tableau);
							}
					}
     					openRequest.onsuccess = function(e) {
      				console.log("Succès");
        			db = e.target.result;
							parcourTable();
      				}
      				openRequest.onerror = function(e) {
       				console.log("Erreur");
        			console.dir(e);
      				}
    	}
	}//fin creation base
},false);//

function ajoutFilm(tf,tab){
  	for (var i = 0; i<tab.length; i++) {
    	  //console.log(tab[i].fields);
    		tf.add(tab[i].fields);
  	};
}


var parcourTable = function(tableau){
		if("indexedDB" in window) {
        idbSupported = true;
    }
    else{
    	    window.alert("Votre navigateur ne supporte pas une version stable d'IndexedDB. Quelques fonctionnalités ne seront pas disponibles.");
    }
	//var request;
    if(idbSupported) {
    		var openRequest = indexedDB.open("BaseFilms",3);
        openRequest.onupgradeneeded = function(e) {
						console.log("running onupgradeneeded");
						db = e.target.result;
				}
        openRequest.onsuccess = function(e) {
		/*
            console.log("Succès");
            db = e.target.result;
			db.transaction("Films").objectStore("Films").get(1).onsuccess = function(event) {
				console.log(event.target.result.adresse);
		};
		*/
						var objectStore = db.transaction("Films").objectStore("Films");
						objectStore.openCursor().onsuccess = function(event) {
								var objet = event.target.result;
								if (objet) {
										if(objet.value.geo_coordinates){
												//console.log("Position du film " + objet.value.titre + " : " +  "latitude : " + objet.value.geo_coordinates[0] + " longitude : " + objet.value.geo_coordinates[1]);
												var pos = {lat: objet.value.geo_coordinates[0], lng: objet.value.geo_coordinates[1], titre: objet.value.titre, annee: objet.value.date_debut_evenement, arrondissement : objet.value.arrondissement };
												listePositions.push(pos)
                        if(parseInt(objet.value.arrondissement)-75000>=1 && parseInt(objet.value.arrondissement)-75000<=20){
                          filmsParArr[parseInt(objet.value.arrondissement)-75001]++;
                        }
										}
										objet.continue();
								}			
								else {		
								initMap(filmsParArr);
								}
						};
        }
        openRequest.onerror = function(e) {
            console.log("Erreur");
            console.dir(e);
        }
    }
}//fin parcoursTable

function initMap(liste) {
		var map = new google.maps.Map(document.getElementById('map'), {
    		zoom: 12,
        	center: {lat: 48.8604392, lng: 2.2940087}
    });
		var markers = listePositions.map(function(location, i) {
    		return new google.maps.Marker({
            		position: location,
			title: listePositions[i].titre
        });
    });
        // ajoute un marker clusterer pour regrouper les markers.
    var markerCluster = new MarkerClusterer(map, markers,
    		{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
	//arondissements
	map.data.loadGeoJson('https://raw.githubusercontent.com/nico12450/ProjetTW3/master/arrondissements.geojson');

  graphe(liste);
}
//fonction qui réinitialise la map et affiche uniquement les films dont l'année correspond à celle passée en paramètre.
function annee(n){
  filmsParArr = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	listePositionsAux = [];
	for (i in listePositions){
		if(listePositions[i].annee.substring(0, listePositions[i].annee.indexOf('-')) == n){
			listePositionsAux.push(listePositions[i]);
      if(parseInt(listePositions[i].arrondissement)-75000>=1 && parseInt(listePositions[i].arrondissement)-75000<=20){
        filmsParArr[parseInt(listePositions[i].arrondissement)-75001]++;
      }
		}
	}	
	//obligé de recopier la fonction car on utilise liste posistionaux
	var map = new google.maps.Map(document.getElementById('map'), {
    		zoom: 12,
        	center: {lat: 48.8604392, lng: 2.2940087}
    });
		var markers = listePositionsAux.map(function(location, i) {
    		return new google.maps.Marker({
            		position: location,
			title: listePositions[i].titre
        });
    });
        // ajoute un marker clusterer pour regrouper les markers.
    var markerCluster = new MarkerClusterer(map, markers,
    		{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

		map.data.loadGeoJson('https://raw.githubusercontent.com/nico12450/ProjetTW3/master/arrondissements.geojson');

    graphe(filmsParArr);
}

    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIvM1Zs36PSS3sRepcj2jCELURlxGgWT4&callback=initMap">
    </script>
    <script
  src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js"></script>
    
    <script>

function graphe(l){
var ctx = document.getElementById("myChart");
var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        //labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],
        datasets: [{
            label: 'nombre de films',
            data: l,
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)'
            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
            ],
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }]
        }
    }
})};

//fonction permettant l'ajout des données du formulaire dans la base de données
function ajoutFormulaire(){

  var titre = $('#titre').val();
  var lon = $('#longitude').val();
  var lat = $('#latitude').val();
  var arrond = $("#arrondissement").val();

  var openRequest = window.indexedDB.open("BaseFilms",3);
 
  openRequest.onsuccess = function(e) {

    db = e.target.result;

    var filmaajouter = [{titre : titre, geo_coordinates : [lon, lat], arrondissement : arrond}]
    
    var objectStore = db.transaction("Films", "readwrite").objectStore("Films");

    objectStore.add(filmaajouter[0]);

    alert("film ajoute avec succes"); 


  }
  openRequest.onerror = function(e) {

    console.log("Erreur");
    console.dir(e);

  }

}
</script>

  </body>
  
</html>

<!doctype html>
<html lang="en">
  <head>
	<meta style = "utf-8">
    <style>
      .map {
        height: 100%;
        width: 100%;
      }
    </style>
    <style>
       #map {
        height: 700px;
        width: 100%;

       }
	#panel{
	    text-align: center;
	    background-color: #e5eecc;
	    border: solid 1px #c3c3c3;
			display: none;
	}
    </style>
    <script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>

		<script> 
$(document).ready(function(){
    $("button").click(function(){
        $("#panel").slideToggle("slow");
    });
});
</script>

    <title>Google map api</title>
  </head>
  <body>
	<FORM NAME="Choix">
<SELECT NAME="Liste">
<OPTION VALUE="" onClick = "initMap()">2002 a 2010
<OPTION VALUE="" onClick = "annee('2002')">2002
<OPTION VALUE="" onClick = "annee('2003')">2003
<OPTION VALUE="" onClick = "annee('2004')">2004
<OPTION VALUE="" onClick = "annee('2005')">2005
<OPTION VALUE="" onClick = "annee('2006')">2006
<OPTION VALUE="" onClick = "annee('2007')">2007
<OPTION VALUE="" onClick = "annee('2008')">2008
<OPTION VALUE="" onClick = "annee('2009')">2009
<OPTION VALUE="" onClick = "annee('2010')">2010
</SELECT>
</FORM>

<button>formulaire</button><br><br>

<form method="post" action="traitement.php" id="panel">
   <fieldset>
       <legend>Informations du film</legend> <!-- Titre du fieldset --> 
       <label for="titre">Titre</label>
       <input type="text" name="titre" id="titre" />
       <label for="nom">Realisateur</label>
       <input type="text" name="nom" id="realisateur" />
       <label for="datedeb">date debut</label>
       <input type="date" name="datedeb" id="date_debut_evenement" />
			 <label for="datefin">date fin</label>
       <input type="date" name="datefin" id="date_fin_evenement" />
			
   </fieldset>
   <fieldset>
       <legend>Localisation du tournage</legend> <!-- Titre du fieldset -->
       <p>
           <input type="radio" name="souhait" value="riche" id="cadreE" /> <label for="riche">Exterieur</label>
           <input type="radio" name="souhait" value="celebre" id="cadreD" /> <label for="celebre">Domaine public</label>        
       </p>
       <p>
           	<label for="lieu">tournage scene</label>
       			<input type="text" name="lieu" id="lieu" />
       </p>
				<p>
           	<label for="adresse">Adresse</label>
       			<input type="text" name="adresse" id="addresse" />
           	<label for="codepostal">Arrondissement</label>
       			<input type="text" name="codepostal" id="arrondissement" />
       </p>
			 <p>
           	<label for="lieu">Adresse complete</label>
       			<input type="text" name="adresse" id="adresse_complete" />

           	<label for="coordonnees">Coordonnees</label>
       			<input type="text" name="coordonnees" id="geo_coordinates" />
       </p>
				<input type="submit" value="Envoyer" />
   </fieldset>
</form>

    <div id="map"></div>
    <canvas id="myChart" width="400" height="400"></canvas>
    <script type="text/javascript">
	
window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
	
const films = [];
const dbName = "MaBase";	
var idbSupported = false;
var db;
var listePositions = [];
var filmsParArr = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
 
document.addEventListener("DOMContentLoaded", function(){
	var tableau;
	$.ajax({
		 url : 'https://raw.githubusercontent.com/nico12450/ProjetTW3/master/tournagesdefilmsparis2011.json',
		 type : 'GET',
		 dataType : 'JSON',
		 success : function(data, statut){
		    tableau = $.parseJSON(JSON.stringify(data));
		    creationBase(tableau);
		 },
		 error : function(resultat, statut, erreur){
		    console.log(erreur);
		 },
		 complete : function(resultat, statut){
		    console.log("tableau de données créé");
		 }
	});


	var creationBase = function(tableau){
   	 	indexedDB.deleteDatabase("BaseFilms");
    	if("indexedDB" in window) {
     	   idbSupported = true;
   		 }
    	else{
    	    window.alert("Votre navigateur ne supporte pas une version stable d'IndexedDB. Quelques fonctionnalités ne seront pas disponibles.");
    	}
			if(idbSupported) {
					var openRequest = indexedDB.open("BaseFilms",3);
 
      		openRequest.onupgradeneeded = function(e) {
							console.log("running onupgradeneeded");
							db = e.target.result;
							var table = db.createObjectStore("Films",{autoIncrement: true});
		//table.createIndex("nom", "nom", {unique: false});
		//table.createIndex("arrondissement", "arrondissement", {unique: false});
							table.transaction.oncomplete = function(e){
									var tableFilm = db.transaction(["Films"], "readwrite").objectStore("Films");
	        				ajoutFilm(tableFilm, tableau);
							}
					}
     					openRequest.onsuccess = function(e) {
      				console.log("Succès");
        			db = e.target.result;
							parcourTable();
      				}
      				openRequest.onerror = function(e) {
       				console.log("Erreur");
        			console.dir(e);
      				}
    	}
	}//fin creation base
},false);//

function ajoutFilm(tf,tab){
  	for (var i = 0; i<tab.length; i++) {
    	  //console.log(tab[i].fields);
    		tf.add(tab[i].fields);
  	};
}


var parcourTable = function(tableau){
		if("indexedDB" in window) {
        idbSupported = true;
    }
    else{
    	    window.alert("Votre navigateur ne supporte pas une version stable d'IndexedDB. Quelques fonctionnalités ne seront pas disponibles.");
    }
	//var request;
    if(idbSupported) {
    		var openRequest = indexedDB.open("BaseFilms",3);
        openRequest.onupgradeneeded = function(e) {
						console.log("running onupgradeneeded");
						db = e.target.result;
				}
        openRequest.onsuccess = function(e) {
		/*
            console.log("Succès");
            db = e.target.result;
			db.transaction("Films").objectStore("Films").get(1).onsuccess = function(event) {
				console.log(event.target.result.adresse);
		};
		*/
						var objectStore = db.transaction("Films").objectStore("Films");
						objectStore.openCursor().onsuccess = function(event) {
								var objet = event.target.result;
								if (objet) {
										if(objet.value.geo_coordinates){
												//console.log("Position du film " + objet.value.titre + " : " +  "latitude : " + objet.value.geo_coordinates[0] + " longitude : " + objet.value.geo_coordinates[1]);
												var pos = {lat: objet.value.geo_coordinates[0], lng: objet.value.geo_coordinates[1], titre: objet.value.titre, annee: objet.value.date_debut_evenement };
												listePositions.push(pos)
                        if(parseInt(objet.value.arrondissement)-75000>=1 && parseInt(objet.value.arrondissement)-75000<=20){
                          filmsParArr[parseInt(objet.value.arrondissement)-75001]++;
                        }
										}
										objet.continue();
								}			
								else {		
								initMap(filmsParArr);
								}
						};
        }
        openRequest.onerror = function(e) {
            console.log("Erreur");
            console.dir(e);
        }
    }
}//fin parcoursTable

function initMap(liste) {
		var map = new google.maps.Map(document.getElementById('map'), {
    		zoom: 12,
        	center: {lat: 48.8604392, lng: 2.2940087}
    });
		var markers = listePositions.map(function(location, i) {
    		return new google.maps.Marker({
            		position: location,
			title: listePositions[i].titre
        });
    });
        // ajoute un marker clusterer pour regrouper les markers.
    var markerCluster = new MarkerClusterer(map, markers,
    		{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
	//arondissements
	map.data.loadGeoJson('https://raw.githubusercontent.com/nico12450/ProjetTW3/master/arrondissements.geojson');

  graphe(liste);
}
//fonction qui réinitialise la map et affiche uniquement les films dont l'année correspond à celle passée en paramètre.
function annee(n){
	listePositionsAux = [];
	for (i in listePositions){
		if(listePositions[i].annee.substring(0, listePositions[i].annee.indexOf('-')) == n){
			listePositionsAux.push(listePositions[i]);
		}
	}	
	//obligé de recopier la fonction car on utilise liste posistionaux
	var map = new google.maps.Map(document.getElementById('map'), {
    		zoom: 12,
        	center: {lat: 48.8604392, lng: 2.2940087}
    });
		var markers = listePositionsAux.map(function(location, i) {
    		return new google.maps.Marker({
            		position: location,
			title: listePositions[i].titre
        });
    });
        // ajoute un marker clusterer pour regrouper les markers.
    var markerCluster = new MarkerClusterer(map, markers,
    		{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

		map.data.loadGeoJson('https://raw.githubusercontent.com/nico12450/ProjetTW3/master/arrondissements.geojson');
}

    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIvM1Zs36PSS3sRepcj2jCELURlxGgWT4&callback=initMap">
    </script>
    <script
  src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js"></script>
    
    <script>

function graphe(l){
var ctx = document.getElementById("myChart");
var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        //labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],
        datasets: [{
            label: '# of Votes',
            data: l,
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)'
            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
            ],
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }]
        }
    }
})};
</script>

  </body>
  
</html>
